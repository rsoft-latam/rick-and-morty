name: Angular Agent Review

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write

jobs:
  rag-review:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: write
      id-token: write
    steps:
      # 1Ô∏è‚É£ Checkout del repo que se est√° revisando
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2Ô∏è‚É£ Node.js para los scripts .mjs
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      # 3Ô∏è‚É£ Construir payload desde el PR
      - name: Build PR payload
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          EXAM_LEVEL: mid            # junior | mid | senior
          MAX_FILES: "10"
          MAX_TOTAL_CHARS: "200000"
          ALLOWED_EXT: ".ts,.html,.scss,.md"
        run: |
          node .github/scripts/agent-review/build-payload.mjs > payload.json
          echo "Payload generated:"
          jq '.files | length' payload.json

      # 4Ô∏è‚É£ Llamar a tu Angular Review Agent (RAG + Pinecone)
      - name: Call Angular Review Agent
        env:
          REVIEW_AGENT_URL: ${{ secrets.REVIEW_AGENT_URL }}
          REVIEW_AGENT_TOKEN: ${{ secrets.REVIEW_AGENT_TOKEN }}
        run: |
          curl -sS -X POST "$REVIEW_AGENT_URL/github/pr-review" \
            -H "Authorization: Bearer $REVIEW_AGENT_TOKEN" \
            -H "Content-Type: application/json" \
            --data @payload.json \
            -o result.json

          echo "Agent response:"
          jq '.' result.json

      # 5Ô∏è‚É£ Publicar o actualizar comentario en el PR
      - name: Upsert PR comment
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          node .github/scripts/agent-review/upsert-comment.mjs result.json

      # ===============================
      # ü§ñ AGENTIC QA (Angular + MCP)
      # ===============================

      # 6Ô∏è‚É£ Instalar dependencias del proyecto Angular
      - name: Install dependencies
        run: npm ci

      # 7Ô∏è‚É£ Build Angular app
      - name: Build Angular app
        run: npm run build --if-present

      # 9Ô∏è‚É£ Servir Angular app (background)
      - name: Serve Angular app
        run: |
          npx serve -s dist -l 4200 &
          sleep 10
      - name: can we comment on PR with gh?
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh auth status || true
          gh pr comment ${{ github.event.pull_request.number }} --body "‚úÖ Debug comment from workflow (gh pr comment)."
      
      - name: Debug external API from runner
        run: |
          curl -I https://rickandmortyapi.com/api/character?page=1 | head -n 20
                  
          
      # 1Ô∏è‚É£1Ô∏è‚É£ Ejecutar Happy Path v√≠a MCP
      - name: Claude QA Review (Angular + MCP)
        id: claude  
        uses: anthropics/claude-code-action@beta
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          github_token: ${{ secrets.GITHUB_TOKEN }}

          direct_prompt: |
            The Angular app is running at http://localhost:4200.

            Run a happy-path UI validation using Playwright MCP:
            1) Go to http://localhost:4200/character
            2) Confirm the page loads
            3) Check if character cards render
            4) If cards exist, click the first "View Character"
            5) Confirm the detail page loads

            Post EXACTLY ONE PR comment (no second comment, no todo list, no extra summary).
            The comment must start with:
            <!-- ANGULAR_CLAUDE_QA -->

            Format:
            <!-- ANGULAR_CLAUDE_QA -->
            ## ü§ñ Claude QA ‚Äì Playwright MCP
            **Result:** PASS|FAIL|PARTIAL PASS
            **Checked:** (3‚Äì6 bullets)
            **Issues:** (only if any)
            **Suggested fix:** (1‚Äì3 bullets)

            Use only:
            gh pr comment ${{ github.event.pull_request.number }} --body "<markdown>"

          mcp_config: |
            {
              "mcpServers": {
                "playwright": {
                  "command": "npx",
                  "args": [
                    "@playwright/mcp@latest",
                    "--allowed-origins",
                    "localhost:4200;fonts.googleapis.com;fonts.gstatic.com;rickandmortyapi.com"
                  ]
                }
              }
            }
          allowed_tools: >
            Bash(gh pr comment:*),
            Bash(gh pr view:*),
            Bash(gh api:*),
            Bash(*),
            Bash(npm:*),
            Bash(sqlite3:*),
            mcp__playwright__browser_navigate,
            mcp__playwright__browser_click,
            mcp__playwright__browser_snapshot,
            mcp__playwright__browser_console_messages        