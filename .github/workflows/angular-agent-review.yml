name: Angular Agent Review

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write

jobs:
  rag-review:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: write
      id-token: write
    steps:
      # 1Ô∏è‚É£ Checkout del repo que se est√° revisando
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2Ô∏è‚É£ Node.js para los scripts .mjs
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      # 3Ô∏è‚É£ Construir payload desde el PR
      - name: Build PR payload
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          EXAM_LEVEL: mid            # junior | mid | senior
          MAX_FILES: "10"
          MAX_TOTAL_CHARS: "200000"
          ALLOWED_EXT: ".ts,.html,.scss,.md"
        run: |
          node .github/scripts/agent-review/build-payload.mjs > payload.json
          echo "Payload generated:"
          jq '.files | length' payload.json

      # 4Ô∏è‚É£ Llamar a tu Angular Review Agent (RAG + Pinecone)
      - name: Call Angular Review Agent
        env:
          REVIEW_AGENT_URL: ${{ secrets.REVIEW_AGENT_URL }}
          REVIEW_AGENT_TOKEN: ${{ secrets.REVIEW_AGENT_TOKEN }}
        run: |
          curl -sS -X POST "$REVIEW_AGENT_URL/github/pr-review" \
            -H "Authorization: Bearer $REVIEW_AGENT_TOKEN" \
            -H "Content-Type: application/json" \
            --data @payload.json \
            -o result.json

          echo "Agent response:"
          jq '.' result.json

      # 5Ô∏è‚É£ Publicar o actualizar comentario en el PR
      - name: Upsert PR comment
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          node .github/scripts/agent-review/upsert-comment.mjs result.json

      # ===============================
      # ü§ñ AGENTIC QA (Angular + MCP)
      # ===============================

      # 6Ô∏è‚É£ Instalar dependencias del proyecto Angular
      - name: Install dependencies
        run: npm ci

      # 7Ô∏è‚É£ Build Angular app
      - name: Build Angular app
        run: npm run build --if-present

      # 9Ô∏è‚É£ Servir Angular app (background)
      - name: Serve Angular app
        run: |
          npx serve -s dist -l 4200 &
          sleep 10
      - name: can we comment on PR with gh?
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh auth status || true
          gh pr comment ${{ github.event.pull_request.number }} --body "‚úÖ Debug comment from workflow (gh pr comment)."
                         
      # 1Ô∏è‚É£1Ô∏è‚É£ Ejecutar Happy Path v√≠a MCP
      - name: Claude QA Review (Angular + MCP)
        id: claude  
        uses: anthropics/claude-code-action@beta
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          github_token: ${{ secrets.GITHUB_TOKEN }}

          direct_prompt: |
            Repository: ${{ github.repository }}
            Pull Request: ${{ github.event.pull_request.number }}
            Branch: ${{ github.event.pull_request.head.ref }}

            The Angular app is running at http://localhost:4200.

            Run a happy-path UI validation using Playwright MCP:
            1) Navigate to http://localhost:4200/character
            2) Verify the Characters page loads successfully
            3) Verify that a list/grid of character cards is visible
            4) Click the first available "View Character" button
            5) Verify that the character detail view loads without errors

            Create a concise markdown report and WRITE it to a file named `claude_qa.md`
            in the repository root.

            The report MUST start with:
            <!-- ANGULAR_CLAUDE_QA -->

            Use this structure:

            <!-- ANGULAR_CLAUDE_QA -->
            ## ü§ñ Claude QA ‚Äì Playwright MCP

            **Result:** PASS|FAIL

            ### Steps Executed
            - ...

            ### Findings
            - ...

            ### Suggested Fixes (only if FAIL)
            - ...

            IMPORTANT:
            - Do NOT post any PR comments yourself.
            - Only generate `claude_qa.md`.

            cat > claude_qa.md << 'EOF'
            <PASTE THE FULL REPORT HERE>
            EOF

          mcp_config: |
            {
              "mcpServers": {
                "playwright": {
                  "command": "npx",
                  "args": [
                    "@playwright/mcp@latest",
                    "--allowed-origins",
                    "localhost:4200"
                  ]
                }
              }
            }
          allowed_tools: >
            Bash(gh pr comment:*),
            Bash(gh pr view:*),
            Bash(gh api:*),
            Bash(*),
            Bash(npm:*),
            Bash(sqlite3:*),
            mcp__playwright__browser_snapshot,
            mcp__playwright__browser_click
            mcp__playwright__browser_navigate
      - name: Post Claude QA comment (guaranteed)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [ ! -f claude_qa.md ]; then
            echo "‚ùå claude_qa.md not found. Claude did not generate the report."
            exit 1
          fi
    
          echo "‚úÖ claude_qa.md found. Posting PR comment..."
          gh pr comment ${{ github.event.pull_request.number }} --body-file claude_qa.md            