name: Angular Agent Review

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write

jobs:
  rag-review:
    runs-on: ubuntu-latest
    steps:
      # 1Ô∏è‚É£ Checkout del repo que se est√° revisando
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2Ô∏è‚É£ Node.js para los scripts .mjs
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      # 3Ô∏è‚É£ Construir payload desde el PR
      - name: Build PR payload
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          EXAM_LEVEL: mid            # junior | mid | senior
          MAX_FILES: "10"
          MAX_TOTAL_CHARS: "200000"
          ALLOWED_EXT: ".ts,.html,.scss,.md"
        run: |
          node .github/scripts/agent-review/build-payload.mjs > payload.json
          echo "Payload generated:"
          jq '.files | length' payload.json

      # 4Ô∏è‚É£ Llamar a tu Angular Review Agent (RAG + Pinecone)
      - name: Call Angular Review Agent
        env:
          REVIEW_AGENT_URL: ${{ secrets.REVIEW_AGENT_URL }}
          REVIEW_AGENT_TOKEN: ${{ secrets.REVIEW_AGENT_TOKEN }}
        run: |
          curl -sS -X POST "$REVIEW_AGENT_URL/github/pr-review" \
            -H "Authorization: Bearer $REVIEW_AGENT_TOKEN" \
            -H "Content-Type: application/json" \
            --data @payload.json \
            -o result.json

          echo "Agent response:"
          jq '.' result.json

      # 5Ô∏è‚É£ Publicar o actualizar comentario en el PR
      - name: Upsert PR comment
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          node .github/scripts/agent-review/upsert-comment.mjs result.json

      # ===============================
      # ü§ñ AGENTIC QA (Angular + MCP)
      # ===============================

      # 6Ô∏è‚É£ Instalar dependencias del proyecto Angular
      - name: Install dependencies
        run: npm ci

      # 7Ô∏è‚É£ Build Angular app
      - name: Build Angular app
        run: npm run build --if-present

      # 9Ô∏è‚É£ Servir Angular app (background)
      - name: Serve Angular app
        run: |
          npx serve -s dist -l 4200 &
          sleep 10

      # 1Ô∏è‚É£1Ô∏è‚É£ Ejecutar Happy Path v√≠a MCP
      - name: Claude QA Review (Angular + MCP)
        id: claude  
        uses: anthropics/claude-code-action@beta
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          custom_instructions: |
            Repository: ${{ github.repository }}
            Pull Request: ${{ github.event.pull_request.number }}
            Branch: ${{ github.event.pull_request.head.ref }}

            The Angular application is already running at:
            http://localhost:4200

            This is a **Rick and Morty characters Angular application**.

            Your task is to perform a **happy-path UI validation** using **Playwright MCP**.

            ---

            ### üß™ Happy Path Steps (execute in order)

            1. Navigate to:
              http://localhost:4200/character

            2. Verify that the **Characters page loads successfully** without errors.

            3. Confirm that a **grid or list of character cards** is rendered.

            4. Ensure that **at least one character card** displays:
              - a character image
              - a character name (e.g. Rick Sanchez, Morty Smith)
              - a **"View Character"** button

            5. Click the **first available "View Character"** button.

            6. Verify that the **character detail view loads correctly** and no runtime or UI errors occur.

            ---

            ### üìù Reporting Rules (IMPORTANT)

            After completing the validation, produce a **markdown report** using the **exact format below**.

            The report MUST start with this marker (do not change it):

            <!-- ANGULAR_CLAUDE_QA -->

            Then include:

            ## ü§ñ Claude QA ‚Äì Playwright MCP

            **Result:** PASS or FAIL

            ### Steps Executed
            - Step 1: ...
            - Step 2: ...
            - Step 3: ...

            ### Findings
            - If PASS:
              - Confirm that the happy path works as expected.
            - If FAIL:
              - Clearly describe what failed
              - Specify which UI element was missing, broken, or not clickable
              - Suggest a likely fix (routing, component logic, API/data loading, selector issue, etc.)

            ---

            ### üì¢ Publishing the Result

            Once the report is ready:

            - Post it as a **NEW comment** on the Pull Request
            - Use the following command to publish it:

            gh pr comment ${{ github.event.pull_request.number }} --body "<paste the full markdown report here>"

            Do NOT edit or overwrite other comments.
            Do NOT mention the RAG agent.
            This comment must be exclusively for **Claude QA (UI validation)**.

          mcp_config: |
            {
              "mcpServers": {
                "playwright": {
                  "command": "npx",
                  "args": [
                    "@playwright/mcp@latest",
                    "--allowed-origins",
                    "localhost:4200"
                  ]
                }
              }
            }
          allowed_tools: >
            Bash(gh pr comment:*),
            mcp__playwright__browser_navigate,
            mcp__playwright__browser_click,
            mcp__playwright__browser_snapshot
